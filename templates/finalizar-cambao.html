{% extends 'sidebar.html' %}

{% block title %}
<title>Apontamento Pintura</title>
{% endblock %}

{% block links %}
<!-- Custom styles for this page -->
<link rel="stylesheet" type="text/css"
    href="{{ url_for('static',filename='vendor/datatables/dataTables.bootstrap4.min.css') }}">

<style>

    .custom-switch.custom-switch-md .custom-control-label {
        padding-left: 1rem;
        padding-bottom: 1.5rem;
    }
    
    .custom-switch.custom-switch-md .custom-control-label::before {
        height: 1.5rem;
        width: calc(2rem + 0.75rem);
        border-radius: 3rem;
    }
    
    .custom-switch.custom-switch-md .custom-control-label::after {
        width: calc(1.5rem - 4px);
        height: calc(1.5rem - 4px);
        border-radius: calc(2rem - (1.5rem / 2));
    }
    
    .custom-switch.custom-switch-md .custom-control-input:checked ~ .custom-control-label::after {
        transform: translateX(calc(1.5rem - 0.25rem));
    }
</style>

{% endblock %}

{% block containerFluid %}

<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Apontamento pintura - Finalizar cambão</h1>
        <!-- <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i
                class="fas fa-download fa-sm text-white-50"></i> Generate Report</a> -->
    </div>

    <!-- Content Row -->
    <div class="row">

        <!-- tabela gerar cambão -->
        <div class="col-xl-12">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Finalizar cambão</h6>
                    <!-- <div class="form-group">
                        <label for="dataCarga">Data da carga</label>
                        <input type="date" name="browser" id="dataCarga" class="form-control">
                    </div> -->
                </div>
                <br>
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <div class="form-row">
                        <!-- <div class="col-sm">
                            <div class="form-group">
                                <label for="cor">Cor</label>
                                <input list="listaCor" id="cor" class="form-control" data-column="5">
                                <datalist id="listaCor"></datalist>
                            </div>
                        </div> -->
                    </div>
                    <div class="p-2">
                        <!-- Switch para PÓ -->
                        <div class="custom-control custom-switch custom-switch-md">
                            <input type="checkbox" class="custom-control-input" id="switchPo">
                            <label class="custom-control-label" for="switchPo">PÓ</label>
                        </div>
                        <!-- Switch para PU -->
                        <div class="custom-control custom-switch custom-switch-md">
                            <input type="checkbox" class="custom-control-input" id="switchPu">
                            <label class="custom-control-label" for="switchPu">PU</label>
                        </div>
                    </div>
                </div>
                
                <!-- Card Body -->
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 100%; overflow-y: auto;">
                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Cambão</th>
                                </tr>
                            </thead>
                            <!-- Tabela com Peças -->
                            <tbody id="tableBody">
                                {% if sheet_data %}
                                    {% for cambao, tipos in sheet_data.items() %}
                                    <!-- Linha do Cambão -->
                                    <tr class="cambao-row" data-cambao="{{ cambao }}" data-tipo="{{ tipos.keys() | join(',') }}">
                                        <td colspan="2"><strong>Cambão:</strong> {{ cambao }}</td>
                                    </tr>
                            
                                    {% for tipo, info in tipos.items() %}
                                    <tr class="button-row" data-tipo="{{ tipo }}">
                                        <td colspan="2">
                                            <button 
                                                class="btn btn-primary btn-sm" 
                                                onclick="toggleTipo('{{ cambao }}', '{{ tipo }}')">
                                                Mostrar Peças (Tipo: {{ tipo }})
                                            </button>
                                            <button 
                                                class="btn btn-success btn-sm" 
                                                onclick="abrirModal('{{ cambao }}', '{{ tipo }}')">
                                                Finalizar
                                            </button>
                                        </td>
                                    </tr>
                            
                                    {% for i in range(info['pecas'] | length) %}
                                    <tr 
                                        class="peca-row cambao-{{ cambao }} tipo-{{ tipo }}" 
                                        style="display: none;" 
                                        data-tipo="{{ tipo }}">
                                        <td colspan="2">
                                            <div style="display: none;"><strong style="display: none;">Id:</strong> {{ info['id'][i] }} - </div>
                                            <strong>Código:</strong> {{ info['codigo'][i] }} -
                                            <strong>Peça:</strong> {{ info['pecas'][i] }} - 
                                            <strong>Quantidade:</strong> {{ info['quantidade'][i] }}
                                            <strong>Cor:</strong> {{ info['cor'][i] }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="2">Nenhum dado disponível</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Content Row -->
    <div class="row">

        <!-- Content Column -->
        <div class="col-lg-12 mb-4">

            <!-- Botão para enviar os itens apontados -->
            <button id="abrirModalOperadorFinalizarCambao" type="button" class="btn btn-success">Enviar</button>

        </div>

    </div>

    <!-- Modal operador -->
    <div class="modal fade" id="operadorFinalizarCambao" tabindex="-1" role="dialog"
        aria-labelledby="operadorFinalizarCambaoLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="operadorFinalizarCambaoLabel">Operador</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <select class="form-control" name="selectOperadorFinalizarCambao"
                                id="selectOperadorFinalizarCambao">
                                <option value=""></option>
                                <option value="Lucas">Lucas</option>
                                <option value="Fábio">Fábio</option>
                                <option value="Paulo Pedro">Paulo Pedro</option>
                                <option value="Herbert">Herbert</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btnFinalizarCambao" type="button" class="btn btn-success" 
                            onclick="enviarDados()">Finalizar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

</div>

<script>
    function showLoading() {
        $('#loading').show();
    }

    function hideLoading() {
        $('#loading').hide();
    }
</script>

<script>
    let dadosSelecionados = []; // Armazena as peças e dados selecionados

    function abrirModal(cambao, tipo) {
        // Seleciona todas as linhas de peças correspondentes ao cambão e tipo
        const pecaRows = document.querySelectorAll(`.peca-row.cambao-${cambao}.tipo-${tipo}`);

        dadosSelecionados = Array.from(pecaRows).map(row => {
            const textoCompleto = row.querySelector('td').innerText;

            // Extrai os valores usando regex ou split
            const id = textoCompleto.match(/Id:\s(.*?)\s-/)?.[1] || null;
            const codigo = textoCompleto.match(/Código:\s(.*?)\s-/)?.[1] || null;
            const peca = textoCompleto.match(/Peça:\s(.*?)\s-/)?.[1] || null;
            const quantidade = textoCompleto.match(/Quantidade:\s(\d+)/)?.[1] || null;
            const cor = textoCompleto.match(/Cor:\s(.*)/)?.[1] || null;

            return {
                id: id,
                codigo: codigo,
                peca: peca,
                quantidade: quantidade ? parseInt(quantidade) : null,
                cor: cor,
                cambao: cambao,
                tipo: tipo
            };
        });

        console.log(dadosSelecionados); // Verifica se os dados estão corretos

        // Exibe o modal
        $('#operadorFinalizarCambao').modal('show');
    }

    function enviarDados() {
        
        showLoading();

        const operador = document.getElementById('selectOperadorFinalizarCambao').value;

        if (!operador) {
            alert('Por favor, selecione um operador.');
            return;
        }

        // Adiciona o operador às informações selecionadas
        const dadosComOperador = dadosSelecionados.map(item => ({
            ...item,
            operador: operador
        }));

        // Envio dos dados via AJAX
        fetch('/receber-dados-finalizar-cambao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ linhas: dadosComOperador, operador: operador })
        })
        .then(response => {
            if (response.ok) {
                $('#operadorFinalizarCambao').modal('hide'); // Fecha o modal
                window.location.reload(); // Recarrega a página
                hideLoading();
            } else {
                alert('Erro ao finalizar o cambão.');
                hideLoading();
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao enviar os dados.');
            hideLoading();
        });
    }

</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Seleciona automaticamente o switch PÓ ao carregar a página
    document.getElementById('switchPo').checked = true;
    switchTipo('PÓ');
});

// Adiciona eventos aos switches
document.getElementById('switchPo').addEventListener('change', () => switchTipo('PÓ'));
document.getElementById('switchPu').addEventListener('change', () => switchTipo('PU'));

function switchTipo(tipoSelecionado) {
    // Desativa o outro switch automaticamente
    if (tipoSelecionado === 'PÓ') {
        document.getElementById('switchPu').checked = false;
        console.log("PÓ");
    } else if (tipoSelecionado === 'PU') {
        document.getElementById('switchPo').checked = false;
    }

    // Exibir apenas os cambões do tipo selecionado
    const cambaoRows = document.querySelectorAll('.cambao-row');
    cambaoRows.forEach(row => {
        const tipos = row.getAttribute('data-tipo').split(',');
        row.style.display = tipos.includes(tipoSelecionado) ? '' : 'none';
    });

    // Exibir apenas os botões do tipo selecionado
    const buttonRows = document.querySelectorAll('.button-row');
    buttonRows.forEach(row => {
        const tipo = row.getAttribute('data-tipo');
        row.style.display = tipo === tipoSelecionado ? '' : 'none';
    });

    // Exibir apenas as peças do tipo selecionado
    // const pecaRows = document.querySelectorAll('.peca-row');
    // pecaRows.forEach(row => {
    //     const tipo = row.getAttribute('data-tipo');
    //     row.style.display = tipo === tipoSelecionado ? '' : 'none';
    // });
}

function toggleTipo(cambao, tipo) {
    const rows = document.querySelectorAll(`.cambao-${cambao}.tipo-${tipo}`);
    let isHidden = Array.from(rows).every(row => row.style.display === 'none');

    // Alterna a visibilidade das peças
    rows.forEach(row => {
        row.style.display = isHidden ? '' : 'none';
    });

    // Altera o texto do botão
    const button = event.target;
    button.textContent = isHidden ? 'Esconder Peças' : `Mostrar Peças (Tipo: ${tipo})`;
}

</script>


{% endblock %}
